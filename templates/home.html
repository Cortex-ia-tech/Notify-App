{% extends 'base.html' %}

{% block title %}Notify - Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
{% endblock %}

{% block content %}
<div class="page-content-wrapper">
    <aside class="sidebar">
        <div class="button-section">
            <a href="{{ url_for('cadastrar') }}" class="button-primary">+ Novo lembrete</a>
        </div>
        <h3>Marcadores</h3>
        <ul class="tag-list">
            <li><a href="{{ url_for('home') }}" class="{% if not active_tag %}active{% endif %}">Todos os Lembretes</a></li>
            {% for tag in marcadores %}
                <li><a href="{{ url_for('home', tag=tag) }}" class="{% if active_tag == tag %}active{% endif %}">{{ tag }}</a></li>
            {% endfor %}
        </ul>
    </aside>

    <main class="main-content">
        <div class="container">
            <div class="quadro">
                <h2>Lembretes ativos:</h2>
                {% if a_vencer %}
                    <ul>
                    {% for id_, nome, vencimento, marcador in a_vencer %}
                        <li>
                            <span>{{ nome }} - vence em {{ vencimento.strftime('%d/%m/%Y') }} <span class="tag-label">[{{ marcador }}]</span></span>
                            <a href="{{ url_for('editar', id=id_) }}">Editar</a>
                            <form action="{{ url_for('excluir', id=id_) }}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este lembrete?');">
                                <button type="submit" class="button-delete">Excluir</button>
                            </form>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum lembrete ativo cadastrado{% if active_tag %} para o marcador "{{ active_tag }}"{% endif %}.</p>
                {% endif %}
            </div>

            <div class="quadro">
                <h2>Lembretes expirados:</h2>
                {% if vencidas %}
                    <ul>
                    {% for id_, nome, vencimento, marcador in vencidas %}
                        <li>
                            <span>{{ nome }} - venceu em {{ vencimento.strftime('%d/%m/%Y') }} <span class="tag-label">[{{ marcador }}]</span></span>
                            <a href="{{ url_for('editar', id=id_) }}">Editar</a>
                            <form action="{{ url_for('excluir', id=id_) }}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este lembrete?');">
                                <button type="submit" class="button-delete">Excluir</button>
                            </form>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum lembrete expirado cadastrado{% if active_tag %} para o marcador "{{ active_tag }}"{% endif %}.</p>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<footer>
    <p>
        Notify 2025 – Desenvolvido por Cortex-IA Business Intelligence® <br> Todos os direitos reservados.
    </p>
</footer>

<script>
    function sincronizarPeriodicamente() {
        fetch('/sincronizar', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    console.log('Sincronização automática concluída');
                } else {
                    console.warn('Erro na sincronização:', data.mensagem);
                }
            })
            .catch(err => {
                console.error('Falha ao tentar sincronizar:', err);
            });
    }

    setInterval(sincronizarPeriodicamente, 5 * 60 * 1000);
    setInterval(() => {
        fetch('/sincronizar_logistica', { method: 'POST' });
    }, 5 * 60 * 1000);
</script>
{% endblock %}
