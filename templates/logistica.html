{% extends 'base.html' %}

{% block title %}Log√≠stica - Notify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='logistica.css') }}">
{% endblock %}

{% block content %}
<div class="tabela-logistica">
    <table>
        <thead>
            <tr>
                <th>Placa</th>
                <th>Aferi√ß√£o</th>
                <th>CIPP</th>
                <th>CIV</th>
                <th>Tac√≥grafo</th>
                <th>AET Federal</th>
                <th>AET Bahia</th>
                <th>AET Goi√°s</th>
                <th>AET Alagoas</th>
                <th>AET Minas Gerais</th>
            </tr>
        </thead>
        <tbody id="corpo-logistica">
            {% if linhas %}
                {% for linha in linhas %}
                <tr>
                    <td><input list="placas" name="placa_{{ loop.index0 }}" value="{{ linha.placa }}"></td>
                    <td><input type="text" name="afericao_{{ loop.index0 }}" value="{{ linha.afericao or '' }}"></td>
                    <td><input type="text" name="cipp_{{ loop.index0 }}" value="{{ linha.cipp or '' }}"></td>
                    <td><input type="text" name="civ_{{ loop.index0 }}" value="{{ linha.civ or '' }}"></td>
                    <td><input type="text" name="tacografo_{{ loop.index0 }}" value="{{ linha.tacografo or '' }}"></td>
                    <td><input type="text" name="aet_federal_{{ loop.index0 }}" value="{{ linha.aet_federal or '' }}"></td>
                    <td><input type="text" name="aet_bahia_{{ loop.index0 }}" value="{{ linha.aet_bahia or '' }}"></td>
                    <td><input type="text" name="aet_goias_{{ loop.index0 }}" value="{{ linha.aet_goias or '' }}"></td>
                    <td><input type="text" name="aet_alagoas_{{ loop.index0 }}" value="{{ linha.aet_alagoas or '' }}"></td>
                    <td><input type="text" name="aet_minas_gerais_{{ loop.index0 }}" value="{{ linha.aet_minas_gerais or '' }}"></td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td><input list="placas" name="placa_0" placeholder="Digite ou escolha"></td>
                    <td><input type="text" name="afericao_0"></td>
                    <td><input type="text" name="cipp_0"></td>
                    <td><input type="text" name="civ_0"></td>
                    <td><input type="text" name="tacografo_0"></td>
                    <td><input type="text" name="aet_federal_0"></td>
                    <td><input type="text" name="aet_bahia_0"></td>
                    <td><input type="text" name="aet_goias_0"></td>
                    <td><input type="text" name="aet_alagoas_0"></td>
                    <td><input type="text" name="aet_minas_gerais_0"></td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<datalist id="placas">
    {% for placa in placas %}
    <option value="{{ placa }}">
    {% endfor %}
</datalist>

<footer>
    <p>
        Notify 2025 ‚Äì Desenvolvido por Cortex-IA Business Intelligence¬Æ <br> Todos os direitos reservados.
    </p>
</footer>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    let linhaIndex = {{ linhas|length if linhas else 1 }}; 

    function criarLinha(index) {
        const tbody = document.getElementById('corpo-logistica');
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td><input list="placas" name="placa_${index}" placeholder="Digite ou escolha" required></td>
            <td><input type="text" name="afericao_${index}"></td>
            <td><input type="text" name="cipp_${index}"></td>
            <td><input type="text" name="civ_${index}"></td>
            <td><input type="text" name="tacografo_${index}"></td>
            <td><input type="text" name="aet_federal_${index}"></td>
            <td><input type="text" name="aet_bahia_${index}"></td>
            <td><input type="text" name="aet_goias_${index}"></td>
            <td><input type="text" name="aet_alagoas_${index}"></td>
            <td><input type="text" name="aet_minas_gerais_${index}"></td>
        `;

        tbody.appendChild(tr);
        adicionarEventosLinha(tr, index);
    }

    function adicionarEventosLinha(tr, index) {
        const placaInput = tr.querySelector(`input[list="placas"]`);
        const inputs = tr.querySelectorAll('input');

        // Ativa salvamento quando os campos mudam
        inputs.forEach(input => {
            if (input !== placaInput) {
                input.addEventListener('input', () => {
                    const placa = placaInput.value.trim().toUpperCase();
                    if (placa.length >= 7) {
                        salvarLinha(tr);
                    }
                });
            }
        });

        // Quando o usu√°rio termina de digitar a placa
        placaInput.addEventListener('change', () => {
            const placa = placaInput.value.trim().toUpperCase();

            if (placa.length >= 7 && index === linhaIndex) {
                linhaIndex++;
                criarLinha(linhaIndex);
            }
        });
    }

    function salvarLinha(tr) {
        const inputs = tr.querySelectorAll('input');
        const dados = {};
        inputs.forEach(input => {
            const nome = input.name.split('_')[0];
            dados[nome] = input.value.trim();
        });

        if (!dados.placa || dados.placa.length < 8) return;

        console.log("üü° Salvando dados da linha:", dados);

        fetch("/salvar_linha_logistica", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(resposta => {
            console.log("‚úÖ Resposta do servidor:", resposta);
        })
        .catch(erro => {
            console.error("‚ùå Erro ao salvar:", erro);
        });
    }

    // Adiciona eventos nas linhas j√° existentes
    document.querySelectorAll('#corpo-logistica tr').forEach((tr, index) => {
        adicionarEventosLinha(tr, index);
    });
});
</script>
{% endblock %}
